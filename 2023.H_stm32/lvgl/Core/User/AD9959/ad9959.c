#include "ad9959.h"



uint8_t FR2_DATA[2] = {0x20, 0x00};//default Value = 0x0000
uint8_t CFR_DATA[3] = {0x00, 0x03, 0x02};//default Value = 0x000302

uint8_t CPOW0_DATA[2] = {0x00, 0x00};//default Value = 0x0000   @ = POW/2^14*360

uint8_t LSRR_DATA[2] = {0x00, 0x00};//default Value = 0x----

uint8_t RDW_DATA[4] = {0x00, 0x00, 0x00, 0x00};//default Value = 0x--------

uint8_t FDW_DATA[4] = {0x00, 0x00, 0x00, 0x00};//default Value = 0x--------

double ACC_FRE_FACTOR = 8.589934592;	//???????8.589934592=(2^32)/500000000 ????500M=25M*20(?????????)
/**
* @brief AD9959??????
* */
static void ad9959_delay(uint32_t length) {
    length = length * 12;
    while (length--);
}

/**
* @brief AD9959?????
* */
void ad9959_init(void) {
    uint8_t FR1_DATA[3] = {0xD0, 0x00,
                           0x00};//20??? Charge pump control = 75uA FR1<23> -- VCO gain control =0? system clock below 160 MHz;

    ad9959_io_init();
    ad9959_reset();

    ad9959_write_data(AD9959_REG_FR1, 3, FR1_DATA, 1);//д????????1
    ad9959_write_data(AD9959_REG_FR2, 2, FR2_DATA, 1);

    //д???????
    // ad9959_write_frequency(AD9959_CHANNEL_0, 1000);
    // ad9959_write_frequency(AD9959_CHANNEL_1, 1000);
    // ad9959_write_frequency(AD9959_CHANNEL_2, 1000);
    // ad9959_write_frequency(AD9959_CHANNEL_3, 1000);

    // ad9959_write_phase(AD9959_CHANNEL_0, 0);
    // ad9959_write_phase(AD9959_CHANNEL_1, 0);
    // ad9959_write_phase(AD9959_CHANNEL_2, 0);
    // ad9959_write_phase(AD9959_CHANNEL_3, 0);

    // ad9959_write_amplitude(AD9959_CHANNEL_0, 0xFF);
    // ad9959_write_amplitude(AD9959_CHANNEL_1, 0xFF);
    // ad9959_write_amplitude(AD9959_CHANNEL_2, 0xFF);
    // ad9959_write_amplitude(AD9959_CHANNEL_3, 0xFF);
}

/**
* @brief AD9959??λ
* */
void ad9959_reset(void) {
    AD9959_RESET_0;
    ad9959_delay(1);
    AD9959_RESET_1;
    ad9959_delay(30);
    AD9959_RESET_0;
}

/**
* @brief AD9959IO??????
* */
void ad9959_io_init(void) {               //???????????????
   
    AD9959_PDC_0;
    AD9959_CS_1;
    AD9959_SCLK_0;
    AD9959_UPDATE_0;
    AD9959_PS0_0;
    AD9959_PS1_0;
    AD9959_PS2_0;
   AD9959_PS3_0;
    AD9959_SDIO0_0;
    AD9959_SDIO1_0;
    AD9959_SDIO2_0;
    AD9959_SDIO3_0;
}

/**
 * @brief AD9959????IO?????
 * */
void ad9959_io_update(void) {
    AD9959_UPDATE_0;
    ad9959_delay(2);
    AD9959_UPDATE_1;
    ad9959_delay(4);
    AD9959_UPDATE_0;
}

/**
 * @brief ???SPI??AD9959д????
 * @param register_address ????????
 * @param number_of_registers ?????????
 * @param register_data ??????????
 * @param update ??????IO?????
 * */
void ad9959_write_data(AD9959_REG_ADDR register_address, uint8_t number_of_registers, const uint8_t *register_data,
                       bool update) {
    uint8_t ControlValue = 0;
    uint8_t ValueToWrite = 0;
    uint8_t RegisterIndex = 0;
    uint8_t i = 0;

    assert_param(IS_AD9959_REG_ADDR(register_address));

    ControlValue = register_address;
//д????
    AD9959_SCLK_0;
    AD9959_CS_0;
    for (i = 0; i < 8; i++) {
        AD9959_SCLK_0;
        if (0x80 == (ControlValue & 0x80))
            AD9959_SDIO0_1;
        else
            AD9959_SDIO0_0;
            AD9959_SCLK_1;
        ControlValue <<= 1;
    }
    AD9959_SCLK_0;
//д??????
    for (RegisterIndex = 0; RegisterIndex < number_of_registers; RegisterIndex++) {
        ValueToWrite = register_data[RegisterIndex];
        for (i = 0; i < 8; i++) {
            AD9959_SCLK_0;
            if (0x80 == (ValueToWrite & 0x80))
                AD9959_SDIO0_1;
            else
                AD9959_SDIO0_0;
            AD9959_SCLK_1;
            ValueToWrite <<= 1;
        }
        AD9959_SCLK_0;
    }
    if (update) ad9959_io_update();
    AD9959_CS_1;
}

/************************************************************
** ???????? ??void Write_CFTW0(uint32_t fre)
** ???????? ??дCFTW0???????????????
** ?????? ?? Freq:	д????????Χ0~200 000 000 Hz
** ??????? ????
** ??????? ????
**************************************************************/
void Write_CFTW0(uint32_t fre)
{
		uint8_t CFTW0_DATA[4] ={0x00,0x00,0x00,0x00};	//?м????
	  uint32_t Temp;            
	  Temp=(uint32_t)fre*ACC_FRE_FACTOR;	 
	  CFTW0_DATA[3]=(uint8_t)Temp;
	  CFTW0_DATA[2]=(uint8_t)(Temp>>8);
	  CFTW0_DATA[1]=(uint8_t)(Temp>>16);
	  CFTW0_DATA[0]=(uint8_t)(Temp>>24);		
		ad9959_write_data(AD9959_REG_CFTW0,4,CFTW0_DATA,0);//CTW0 address 0x04
}

/************************************************************
** ???????? ??void Write_ACR(uint16_t Ampli)
** ???????? ??дACR????????????????
** ?????? ??Ampli:    ???????,??Χ0~1023???????0~1023??????????0~500mVpp????
** ??????? ????
** ??????? ????
**************************************************************/
void Write_ACR(uint16_t Ampli)
{ 
	uint32_t A_temp=0;
	uint8_t ACR_DATA[3] = {0x00,0x00,0x00};//default Value = 0x--0000 Rest = 18.91/Iout 
  A_temp=Ampli|0x1000;
	
	ACR_DATA[1] = (uint8_t)(A_temp>>8); //??λ????
	ACR_DATA[2] = (uint8_t)A_temp;  //??λ????
  ad9959_write_data(AD9959_REG_ACR,3,ACR_DATA,0); //ACR address 0x06.CHn?趨????
}

/************************************************************
** ???????? ??void Write_CPOW0(uint16_t Phase)
** ???????? ??дCPOW0?????λ?????????
** ?????? ??Phase:		?????λ,??Χ??0~16383(???????0??~360??)
** ??????? ????
** ??????? ????
**************************************************************/
void Write_CPOW0(uint16_t Phase)
{
	uint8_t CPOW0_data[2] = {0x00,0x00};
	CPOW0_data[1]=(uint8_t)Phase;
	CPOW0_data[0]=(uint8_t)(Phase>>8);

	ad9959_write_data(AD9959_REG_CPOW0,2,CPOW0_data,0);//CPOW0 address 0x05.CHn?趨??λ
}

/************************************************************
** ???????? ??void Write_LSRR(uint8_t rsrr,uint8_t fsrr)
** ???????? ??дLSRR???????б??????
** ?????? ??	rsrr:	????б??,??Χ??0~255
							fsrr:	???б??,??Χ??0~255
** ??????? ????
** ??????? ????
**************************************************************/
void Write_LSRR(uint8_t rsrr,uint8_t fsrr)
{
	uint8_t LSRR_data[2]={0x00,0x00};

	LSRR_data[1]=rsrr;	
	LSRR_data[0]=fsrr;//??8λ???б??

	ad9959_write_data(AD9959_REG_LSRR,2,LSRR_data,0);
}

/************************************************************
** ???????? ??void Write_RDW(uint32_t r_delta)
** ???????? ??дRDW?????????????
** ?????? ??r_delta:????????,0-4294967295
** ??????? ????
** ??????? ????
**************************************************************/
void Write_RDW(uint32_t r_delta)
{
		uint8_t RDW_data[4] ={0x00,0x00,0x00,0x00};	//?м????          
 
	  RDW_data[3]=(uint8_t)r_delta;
	  RDW_data[2]=(uint8_t)(r_delta>>8);
	  RDW_data[1]=(uint8_t)(r_delta>>16);
	  RDW_data[0]=(uint8_t)(r_delta>>24);		
		ad9959_write_data(AD9959_REG_RDW,4,RDW_data,0);
}

/************************************************************
** ???????? ??void Write_FDW(uint32_t f_delta)
** ???????? ??дFDW????????????
** ?????? ??f_delta:???????,0-4294967295
** ??????? ????
** ??????? ????
**************************************************************/
void Write_FDW(uint32_t f_delta)
{
		uint8_t FDW_data[4] ={0x00,0x00,0x00,0x00};	//?м????          
 
	  FDW_data[3]=(uint8_t)f_delta;
	  FDW_data[2]=(uint8_t)(f_delta>>8);
	  FDW_data[1]=(uint8_t)(f_delta>>16);
	  FDW_data[0]=(uint8_t)(f_delta>>24);		
		ad9959_write_data(AD9959_REG_FDW,4,FDW_data,0);
}

/************************************************************
** ???????? ??void Write_Profile_Fre(uint8_t profile,uint32_t data)
** ???????? ??дProfile?????
** ?????? ??profile:	profile??(0~14)
							data:	д????????Χ0~200 000 000 Hz
** ??????? ????
** ??????? ????
**************************************************************/
void Write_Profile_Fre(uint8_t profile,uint32_t data)
{
		uint8_t profileAddr;
		uint8_t Profile_data[4] ={0x00,0x00,0x00,0x00};	//?м????
	  uint32_t Temp;            
	  Temp=(uint32_t)data*ACC_FRE_FACTOR;	   //?????????????????????  4.294967296=(2^32)/500000000
	  Profile_data[3]=(uint8_t)Temp;
	  Profile_data[2]=(uint8_t)(Temp>>8);
	  Profile_data[1]=(uint8_t)(Temp>>16);
	  Profile_data[0]=(uint8_t)(Temp>>24);
		profileAddr = 0x0A + profile;
		
		ad9959_write_data(profileAddr,4,Profile_data,0);
}


/**
 * @brief ????????????λ
 * @param channel ??????
 * @param phase ?????λ 14bit ?????λ??Χ??0~16383(???????0??~360??)
 * */
void ad9959_write_phase(AD9959_CHANNEL channel, uint16_t phase) {
    uint8_t cs_data = channel;
    assert_param(IS_AD9959_CHANNEL(channel));
    CPOW0_DATA[1] = (uint8_t) phase;
    CPOW0_DATA[0] = (uint8_t) (phase >> 8);
    ad9959_write_data(AD9959_REG_CSR, 1, &cs_data, 1);
    ad9959_write_data(AD9959_REG_CPOW0, 2, CPOW0_DATA, 1);

}

/**
 * @brief ?????????????
 * @param channel ??????
 * @param amplitude ?????? (????Χ 1 ~ 200000000Hz)
 * */
void ad9959_write_frequency(AD9959_CHANNEL channel, uint32_t Freq) {
    uint8_t CFTW0_DATA[4] = {0x00, 0x00, 0x00, 0x00};    //?м????
    uint32_t frequency;
    uint8_t cs_data = channel;

    assert_param(IS_AD9959_CHANNEL(channel));

    frequency = (uint32_t) Freq * 8.589934592;       //?????????????????????  8.589934592=(2^32)/500000000 ????500M=25M*20(?????????)
    CFTW0_DATA[3] = (uint8_t) frequency;
    CFTW0_DATA[2] = (uint8_t) (frequency >> 8);
    CFTW0_DATA[1] = (uint8_t) (frequency >> 16);
    CFTW0_DATA[0] = (uint8_t) (frequency >> 24);

    ad9959_write_data(AD9959_REG_CSR, 1, &cs_data, 1);
    ad9959_write_data(AD9959_REG_CFTW0, 4, CFTW0_DATA, 1);


}

void ad9959_write_frequency1(AD9959_CHANNEL channel, uint32_t Freq) {
    uint8_t CFTW0_DATA[4] = {0x00, 0x00, 0x00, 0x00};    //?м????
    uint32_t frequency;
    uint8_t cs_data = channel;

    assert_param(IS_AD9959_CHANNEL(channel));

    frequency = (uint32_t) Freq * 8.589934592;       //?????????????????????  8.589934592=(2^32)/500000000 ????500M=25M*20(?????????)
    CFTW0_DATA[3] = (uint8_t) frequency;
    CFTW0_DATA[2] = (uint8_t) (frequency >> 8);
    CFTW0_DATA[1] = (uint8_t) (frequency >> 16);
    CFTW0_DATA[0] = (uint8_t) (frequency >> 24);

    ad9959_write_data(AD9959_REG_CSR, 1, &cs_data, 1);
    ad9959_write_data(AD9959_REG_CFTW0, 4, CFTW0_DATA, 1);


}

/**
 * @brief ??????????????
 * @param channel ??????
 * @param amplitude ??????? 10bit ?????λ??Χ??0~1023(????????0 ~ 530mV)
 * */
void ad9959_write_amplitude(AD9959_CHANNEL channel, uint16_t amplitude) {
    uint8_t ACR_DATA[3] = {0x00, 0x00, 0x00};//default Value = 0x--0000 Rest = 18.91/Iout
    uint8_t cs_data = channel;

    assert_param(IS_AD9959_CHANNEL(channel));

    amplitude = amplitude | 0x1000;
    ACR_DATA[2] = (uint8_t) amplitude;
    ACR_DATA[1] = (uint8_t) (amplitude >> 8);

    ad9959_write_data(AD9959_REG_CSR, 1, &cs_data, 1);
    ad9959_write_data(AD9959_REG_ACR, 3, ACR_DATA, 1);

}

/************************************************************
** ???????? ??void AD9959_Modulation_Init(uint8_t Channel,uint8_t Modulation,uint8_t Sweep_en,uint8_t Nlevel)
** ???????? ?????????????????????
** ?????? ?? Channel:  	?????? CH0-CH3
							Modulation:	??????DISABLE_Mod??ASK??FSK??PSK
							Sweep_en:		????????? SWEEP_ENABLE???á?SWEEP_DISABLE????????????Nlevel?????LEVEL_MOD_2
							Nlevel??		????????? LEVEL_MOD_2??4??8??16
** ??????? ????
** ??????? ???罫???????????2???????????????P0-P3?????????????????CH0-CH3???(????????????????)
							?罫???????????4???????????????P0??P1??P2,P3?????????????????CH0-CH1???(????????????????)
							????AD9959???P0-P3,4??????????????????????????4???????????????2?????????????????????
							8?????16???????????????1?????????????????????????????ü?????????????????????

**????????????ó?4??????????????????????CH0-1
							???ó?8,16??????????????????????CH0
							??????δ?????????????????巽????ο?AD9959о????22-23???????FR1[14:12]???????
**************************************************************/
void AD9959_Modulation_Init(uint8_t Channel,uint8_t Modulation,uint8_t Sweep_en,uint8_t Nlevel)
{
	uint8_t i=0;
	uint8_t CHANNEL[1]={0x00};
	uint8_t FR1_data[3];
	uint8_t FR2_data[2];
	uint8_t CFR_data[3];
  uint8_t FR1_DATA[3] = {0xD0, 0x00,
                           0x00};   //PLL*5
	for(i=0;i<3;i++)//????????
	{
		FR1_data[i]=FR1_DATA[i];
		CFR_data[i]=CFR_DATA[i];
	}
	FR2_data[0]=FR2_DATA[0];
	FR2_data[1]=FR2_DATA[1];
		
	CHANNEL[0]=Channel;
	ad9959_write_data(AD9959_REG_CSR,1,CHANNEL,0); //????????д??CHn????????CHn??????????????CHn
	
	FR1_data[1]=Nlevel;
	CFR_data[0]=Modulation;
	CFR_data[1]|=Sweep_en;
	CFR_data[2]=0x00;

	if(Channel!=0)//??????????
	{
		ad9959_write_data(AD9959_REG_FR1,3,FR1_data,0);//д????????1
		ad9959_write_data(AD9959_REG_FR2,2,FR2_data,0);//д????????1
		ad9959_write_data(AD9959_REG_CFR,3,CFR_data,0);//д???????????
	}
}

/************************************************************
** ???????? ??void AD9959_SetFre_Sweep(uint8_t Channel, uint32_t s_data,uint32_t e_data,uint8_t fsrr,uint8_t rsrr,uint32_t r_delta,uint32_t f_delta,uint16_t Phase)
** ???????? ?????????????????
** ?????? ??Channel:  ?????? CH0-CH3
							s_data:	?????????Χ0~200 000 000 Hz
							e_data:	??????????Χ0~200 000 000 Hz
							r_delta:???????????,0~200 000 000Hz
							f_delta:??????????,0~200 000 000Hz

							rsrr:		????б??,??Χ??1~255????????500Mhz????????????8ns
							fsrr:		???б??,??Χ??1~255
							Ampli:	???????,??Χ0~1023???????0~1023??????????0~500mVpp????
							Phase:	?????λ,??Χ??0~16383(???????0??~360??)
** ??????? ????
** ??????? ????????????????? dT = Xsrr*8 ??λns????????=(???-????)/????
							???????=??????????*dT
**************************************************************/
void AD9959_SetFre_Sweep(uint8_t Channel, uint32_t s_data,uint32_t e_data,uint32_t r_delta,uint32_t f_delta,uint8_t rsrr,uint8_t fsrr,uint16_t Ampli,uint16_t Phase)
{
	uint8_t CHANNEL[1]={0x00};
	uint32_t Fer_data=0;            
	
	CHANNEL[0]=Channel;
	ad9959_write_data(AD9959_REG_CSR,1,CHANNEL,0); //????????д??CHn????????CHn??????????????CHn
	
	Write_CPOW0(Phase);//??????λ
	Write_ACR(Ampli); //????????
	
	Write_LSRR(rsrr,fsrr);//б??
	
	Fer_data=(uint32_t)r_delta*ACC_FRE_FACTOR;	 //?????????????
	Write_RDW(Fer_data);//????????
	
	Fer_data=(uint32_t)f_delta*ACC_FRE_FACTOR;
	Write_FDW(Fer_data);//???????
	
	Write_CFTW0(s_data);//??????
	Write_Profile_Fre(0, e_data);//???????
}

void sweep_init(void)
{
  //设置频率线???扫描，Nlevel只能是LEVEL_MOD_2
	AD9959_Modulation_Init(AD9959_CHANNEL_1|AD9959_CHANNEL_2,FSK,SWEEP_ENABLE,LEVEL_MOD_2);//通道0-3设置为FSK模式，启用线性扫描，2电平调制
	
										//	通道，起始频率，结束频率，上升步长频率，下降步长频率，上升斜率，下降斜率，幅 ，相
	AD9959_SetFre_Sweep(AD9959_CHANNEL_1,		80000, 1000000,			1,							1,				250,		250,			400,		4096);
	//上述函数效果为：1000Hz扫描100,000Hz，步1hz，扫频时间约198ms；再100000Hz扫描1000Hz，步1hz，扫频时间约198ms；扫频时间计算参考函数注????????
		AD9959_SetFre_Sweep(AD9959_CHANNEL_2,		80000, 1000000,			1,							1,				250,		250,			400,		0);
	//每个通道的频率线性扫描参数可以不同，单独设置即可
	//也可不将有???道都设置为频率线???扫描模式，则未设置频率线???扫描模式的通道，可使用AD9959_Set_Fre等函数独立设置其频率、幅度???相;或设置成其他调制模式????????

	ad9959_io_update();	//AD9959更新数据,调用此函数后，上述操作生效！！！
}
